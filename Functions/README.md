# Registrar Functions

The main functions in Registrar software are:
- <a href='https://github.com/neurogeometry/'>Registration()</a> (generates the stack overlaps information)</br>
- <a href='https://github.com/neurogeometry/'>FindOverlaps()</a> (generates the stack overlaps information)</br>
- <a href='https://github.com/neurogeometry/'>Feature Extraction()</a> (find features in overlaps regions of all stacks)</br>
- <a href='https://github.com/neurogeometry/'>Feature Matching()</a> (pairwise feature matching) </br>
- <a href='https://github.com/neurogeometry/'>Global Registration()</a> (minimize the registration error globally and find transformation for each stack) </br>
- <a href='https://github.com/neurogeometry/'>Blending()</a> (generate seamless registered image for visualization)</br>
- <a href='https://github.com/neurogeometry/'>Retiling()</a> (generate final tiles)</br>
- <a href='https://github.com/neurogeometry/'>CreateZoomLevels()</a> (create different zoom levels)</br>

## Registration()
This is the main function in the GUI file (Registrar.m) which runs when user set parameters and click on Run on the GUI. 
```
try
    registeration(StackList_csv_pth,TransformationValue,Seq_Par,Par_workers,blendingSID,handles,LogHandle)
catch ME
    LogHandle.Children(2).String = ME.getReport;
end
```
The inputs of this function includes:

- StackList_csv_pth : the path to the input <a href='https://github.com/neurogeometry/Registrar#a-sample-input-csv-file-content'>CSV file</a>. 
- TransformationValue: this parameter defines the transformation type, 1 for Translation, 2 for Rigid, 3 for Affine, and 4 for B-Spline.
- Seq_Par: 1 for run in sequential, and 2 for parallel 
- Par_workers: sets the number of workers to be used from the local or remote cluster if Seq_Par = 1.
- blendingSID: the stack ID to be shown along with its neighboring stacks as a sample of the registration result.
- handles: the handles object of the main GUI.
- LogHandle: the handles object of the Log GUI.

## FindOverlaps()
The main function called FindOverlaps which called inside registration.m file:
```
All_overlaps = FindOverlaps(handles,StackPositions_pixels,StackSizes_pixels,StackList);
```
The inputs includes:</br>
- handles: the handles object of the main GUI.
- StackPositions_pixels: the original stack positions generated by Microscope. The size of the matrix is 3*N where 3 corresponsd to x,y,z positions and N is the number of image stacks. 
- StackSizes_pixels: the size of each stack. The size of the matrix is 3*N where 3 corresponsd to stack sizes in 3 dimentions and N is the number of image stacks. 

Stack positions and stack sizes are used to find the overlap regions between image stacks and determine each stack is overlaps with which other stacks. </br>
The output is:</br>
- All_overlaps: N*N matrix which each element determines the amount of overlap between stack i and stack j in the dataset. If there is no overlap between stack i and j, the value would be 0.

## FeatureExtraction()
In order to register image stack, we first extract features in the overlap regions of all images. The main feature extraction function is FeatureExtraction which is in the registration.m file: 
```
FeatureExtraction(handles,LogHandle,StackList,DataFolder,Seq_Par,Par_workers,All_overlaps,StackPositions_pixels,StackSizes_pixels);
```
The inputs of this functions includes:
- handles: the handles object of the main GUI.
- LogHandle: the handles object of the Log GUI.
- StackList: list of image stacks along with their location on the disk.
- DataFolder: the address of the output directory. The features will be saved in this folder.
- Seq_Par: 1 for run in sequential, and 2 for parallel 
- Par_workers: sets the number of workers to be used from the local or remote cluster if Seq_Par = 1.
- All_overlaps: stack overlaps information which tells which stacks are overlaps.
- StackPositions_pixels: the original stack positions generated by Microscope. The size of the matrix is 3*N where 3 corresponsd to x,y,z positions and N is the number of image stacks. 
- StackSizes_pixels: the size of each stack. The size of the matrix is 3*N where 3 corresponsd to stack sizes in 3 dimentions and N is the number of image stacks.

To avoid extra processing, only features in the overlap regions will be extracted in this function. 

## Feature Matching()
Feature matching performs a pairwise matching. For this goal, All_overlaps matrix is used to determine each stack is overlaps with which stack. The main feature matching function is Generate_Reg_MatchedPoints() function located in the registration.m file:

```
Generate_Reg_MatchedPoints(handles,LogHandle,All_overlaps,StackList,StackPositions_pixels,StackSizes_pixels,TransformationValue,DataFolder,Seq_Par,Par_workers,params.FM.mu);
```   
The inputs of this functions includes:
- handles: the handles object of the main GUI.
- LogHandle: the handles object of the Log GUI.
- All_overlaps: stack overlaps information which tells which stacks are overlaps.
- StackList: list of image stacks along with their location on the disk.
- StackPositions_pixels: the original stack positions generated by Microscope. The size of the matrix is 3*N where 3 corresponsd to x,y,z positions and N is the number of image stacks. 
- StackSizes_pixels: the size of each stack. The size of the matrix is 3*N where 3 corresponsd to stack sizes in 3 dimentions and N is the number of image stacks. 
- TransformationValue: this parameter defines the transformation type, 1 for Translation, 2 for Rigid, 3 for Affine, and 4 for B-Spline.
- DataFolder: the address of the output directory. The features will be saved in this folder.
- Seq_Par: 1 for run in sequential, and 2 for parallel 
- Par_workers: sets the number of workers to be used from the local or remote cluster if Seq_Par = 1.
- params.FM.mu: the regularization parameter which used in Affine and B-slpine transforms.

The output of this process is a 6*M*N matrix. x,y,z postions of the points in the first stack and x,y,z position of the corresponding matched point in the second stack determined which points should be matched. M is the number of matches in each stack pairs. and N is the number of stack pairs which we found matches between them. 

## Global Registration()
In order to minimize the registration error globally, a global optimization approach is performed by Global_Linear_Transform function:  
```
Global_Linear_Transform(StackPositions_pixels,Matched,Transform_Type,DataFolder);
```
The inputs of this functions includes:
- StackPositions_pixels: the original stack positions generated by Microscope. The size of the matrix is 3*N where 3 corresponsd to x,y,z positions and N is the number of image stacks. 
Matched: a 6*M*N matrix. x,y,z postions of the points in the first stack and x,y,z position of the corresponding matched point in the second stack determined which points should be matched. M is the number of matches in each stack pairs. and N is the number of stack pairs which we found matches between them. 
- Transform_Type: this parameter defines the transformation type, 1 for Translation, 2 for Rigid, 3 for Affine, and 4 for B-Spline.
- DataFolder: the address of the output directory. The features will be saved in this folder.

The output of this process is T which includes the final transformations for each stack. T.b is the translation of each srack, T.R is the Rigid transform for each stack, and T.L is the Affine transform per stack.

## Blending()
For GUI visualization purpose, this function will generate a registered seamless image stack. You can choose a stack ID from the GUI and this function will show the result of registration for that stack and all neighboring image stacks. The main Blending function is blending() located in the registration.m file:
```
blending(StackPositions_pixels,StackSizes_pixels,StackList,blendingSID,T.L,T.b,DataFolder);  
```
The inputs of this functions includes
- StackPositions_pixels: the original stack positions generated by Microscope. The size of the matrix is 3*N where 3 corresponsd to x,y,z positions and N is the number of image stacks. 
- StackSizes_pixels: the size of each stack. The size of the matrix is 3*N where 3 corresponsd to stack sizes in 3 dimentions and N is the number of image stacks.
- StackList: list of image stacks along with their location on the disk.
- blendingSID: stack Id to generate registered image.
- T.L: the transformation information.
- T.b: the translation information.
- DataFolder: the address of the output directory. The features will be saved in this folder.


## Retiling()
In order to generate the final result of the registration, we generate non-overap registered tiles. This process performed in the Retiling() function located in the registration.m file:
```
Retiling(handles,LogHandle,{StackList{:,1}},StackPositions_pixels,StackSizes_pixels,T,DataFolder,outputType,Seq_Par,Par_workers,DBAddress);
```
The inputs of this functions includes:
- StackList{:,1}: list of the image stacks locations on the disk
- StackPositions_pixels: the original stack positions generated by Microscope. The size of the matrix is 3*N where 3 corresponsd to x,y,z positions and N is the number of image stacks. 
- StackSizes_pixels: the size of each stack. The size of the matrix is 3*N where 3 corresponsd to stack sizes in 3 dimentions and N is the number of image stacks.
- T: the transformation information for all image stacks
- DataFolder: the address of the output directory. The features will be saved in this folder.
- outputType: the type of output: 
1. NCTracer SQLite database format
2. Tiff volume file format
3. Google Neuroglancer format
4. Nifti volume format
5. HDF5 database format
6. Catmaid format
7. NCTRacer JPEG compresion

